services:
  rtabmap_kinect:
    image: introlab3it/rtabmap:focal
    
    command: rtabmap

    # 3. Environment Variables for X11 forwarding and optimization
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      # Note: We rely on the host setup for XAUTHORITY access
      - XAUTHORITY=${XAUTHORITY}
      # NVIDIA variables
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - OMP_WAIT_POLICY=passive
      - XDG_CACHE_HOME=/workspace/cache

    # 4. Hardware and Capability Settings
    runtime: nvidia # Enables the use of the NVIDIA Container Toolkit
    network_mode: host # Allows the container to use the host's network stack
    privileged: true   # Grants broad access needed for device/driver interaction

    # 5. Volume Mounts (Persisted data and device access)
    volumes:
      # X11 Socket for Graphical Display
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # XAUTHORITY file for Secure X11 Access (Requires host setup)
      - ${XAUTHORITY}:${XAUTHORITY}
      # Kinect/USB device access
      - /dev/bus/usb:/dev/bus/usb
      # RTAB-Map documents folder
      - ~/Documents/RTAB-Map:/root/Documents/RTAB-Map
      # Repository output folder
      - ../datasets:/workspace/datasets
      - ../output:/workspace/output
      - ../thirdparty:/workspace/thirdparty
      - ../cache:/workspace/cache
      - .:/workspace/rtabmap_context